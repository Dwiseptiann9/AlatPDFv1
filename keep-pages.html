<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Simpan Halaman Tertentu</title>
  
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="page-header">
    <a href="index.html" class="back-link">‚Üê Kembali ke Portal</a>
    <h1>Simpan Halaman Tertentu</h1>
    <p>Upload file PDF, masukkan halaman yang ingin DISIMPAN. Halaman lainnya akan dihapus.</p>
  </header>

  <main class="container">
    <div class="card">
        <div class="input-grid">
          <div class="input-column">
            <label class="setting-label">1. File PDF (Bisa Banyak)</label>
            <div id="pdfDropzone" class="dropzone">Klik atau Drop File</div>
          </div>
          <div class="input-column">
            <label for="pagesToKeepInput" class="setting-label">2. Halaman yang INGIN DISIMPAN</label>
            <input type="text" id="pagesToKeepInput" class="input-field" placeholder="Contoh: 8 (atau: 1, 3, 5-7)" style="height: 180px; text-align: center; font-size: 1.1em;">
          </div>
        </div>
    </div>
    
    <div class="card action-panel" id="previewCard" style="display: none;">
        <label class="setting-label" style="text-align: center; margin-top: 0; margin-bottom: 20px;">Pratinjau Nama File</label>
        <div id="previewWrapper">
            <div id="previewContainer"></div>
        </div>
        <div class="filename-container" style="margin-top: 24px;">
            <label for="suffixInput" class="setting-label" style="text-align: center; margin-top: 0;">üè∑Ô∏è Teks Tambahan Nama File (Opsional)</label>
            <input type="text" id="suffixInput" class="input-field" placeholder="Contoh: -Halaman_8 atau _Filtered">
        </div>
    </div>

    <button id="processButton" class="button-primary button-large" disabled>Simpan Halaman & Unduh ZIP</button>
    <div id="output" class="status-box">Menunggu file...</div>
  </main>

  <script>
    const { PDFDocument } = PDFLib;
    const { JSZip } = window;

    // --- Variabel Global ---
    let pdfFiles = [];
    let isProcessing = false;
    const pdfDropzone = document.getElementById('pdfDropzone');
    const pagesToKeepInput = document.getElementById('pagesToKeepInput');
    const processButton = document.getElementById('processButton');
    const output = document.getElementById('output');
    const suffixInput = document.getElementById('suffixInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewCard = document.getElementById('previewCard');
    
    // --- Fungsi Reset UI ---
    function resetUI() {
        pdfFiles = [];
        isProcessing = false;
        
        pdfDropzone.textContent = 'Klik atau Drop File';
        pdfDropzone.classList.remove('has-file');
        
        pagesToKeepInput.value = '';
        suffixInput.value = '';
        previewContainer.innerHTML = '';
        previewCard.style.display = 'none';
        
        processButton.disabled = true;
        output.textContent = 'Menunggu file...';
        output.className = 'status-box';
    }

    // --- Pratinjau Nama File ---
    function updatePreviewTable() {
      previewContainer.innerHTML = ''; 
      if (pdfFiles.length === 0) {
          previewCard.style.display = 'none';
          return;
      }
      
      previewCard.style.display = 'block';
      const suffixText = suffixInput.value;
      const table = document.createElement('table');
      table.id = 'previewTable';
      table.innerHTML = '<thead><tr><th>No.</th><th>Nama File Hasil (Pratinjau)</th></tr></thead>';
      const tbody = document.createElement('tbody');

      for (let i = 0; i < pdfFiles.length; i++) {
        const tr = document.createElement('tr');
        const originalName = pdfFiles[i].name.replace(/\.pdf$/i, "");
        const finalNamePreview = `${originalName}${suffixText}.pdf`;
        tr.innerHTML = `<td>${i + 1}</td><td>${finalNamePreview}</td>`;
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      previewContainer.appendChild(table);
    }
    suffixInput.addEventListener('input', updateStatus);

    // --- Pengaturan Dropzone ---
    function setupDropzone(element, filesContainer) {
      const handleFiles = (files) => {
        if (isProcessing) return;
        output.className = 'status-box'; 
        const newPdfFiles = [...files].filter(f => f.type === 'application/pdf');
        if (newPdfFiles.length === 0) return;
        
        filesContainer.length = 0; 
        filesContainer.push(...newPdfFiles); 
        
        element.textContent = `${filesContainer.length} file PDF dipilih.`;
        element.classList.add('has-file');
        updateStatus(); 
      };
      
      const handleClick = () => {
        if (isProcessing) return;
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/pdf';
        input.multiple = true;
        input.onchange = (e) => handleFiles(e.target.files);
        input.click();
      };
      
      const dragOverHandler = (e) => { e.preventDefault(); if (!isProcessing) element.classList.add('dragover'); };
      const dragLeaveHandler = () => element.classList.remove('dragover');
      const dropHandler = (e) => {
        e.preventDefault();
        if (isProcessing) return;
        element.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      };

      element.addEventListener('click', handleClick);
      element.addEventListener('dragover', dragOverHandler);
      element.addEventListener('dragleave', dragLeaveHandler);
      element.addEventListener('drop', dropHandler);
    }
    
    setupDropzone(pdfDropzone, pdfFiles);

    // --- Update Status (Logika Tombol) ---
    function updateStatus() {
      if (pdfFiles.length > 0) {
          updatePreviewTable();
      }
      
      const pagesStr = pagesToKeepInput.value.trim();
      
      if (isProcessing) return; 

      // JANGAN ubah status jika saat ini sedang menampilkan error
      if (output.className.includes('status-error')) {
          // Jika user mulai mengetik lagi, baru reset error
          if (pagesStr !== "" && pdfFiles.length > 0) {
              output.className = 'status-box';
          } else {
              processButton.disabled = true;
              return; // Biarkan pesan error tetap tampil
          }
      }

      if (pdfFiles.length > 0 && pagesStr !== "") {
        output.textContent = `Siap memproses ${pdfFiles.length} file.`;
        processButton.disabled = false;
      } else {
        processButton.disabled = true;
        if (pdfFiles.length === 0) {
          output.textContent = 'Menunggu file...';
        } else {
          output.textContent = 'Menunggu nomor halaman...';
        }
      }
    }
    
    pagesToKeepInput.addEventListener('input', updateStatus);

    // --- Fungsi Bantuan: Mem-parsing Halaman ---
    function parsePageIndices(str) {
      const indices = new Set();
      if (str.trim() === '') return [];

      const parts = str.split(',');
      for (const part of parts) {
        const trimmedPart = part.trim();
        if (trimmedPart.includes('-')) {
          const [start, end] = trimmedPart.split('-').map(s => parseInt(s.trim()));
          if (!isNaN(start) && !isNaN(end) && start > 0 && end >= start) {
            for (let i = start; i <= end; i++) {
              indices.add(i - 1); // 0-based index
            }
          }
        } else {
          const pageNum = parseInt(trimmedPart);
          if (!isNaN(pageNum) && pageNum > 0) {
            indices.add(pageNum - 1); // 0-based index
          }
        }
      }
      return Array.from(indices).sort((a, b) => a - b);
    }
    
    // --- Fungsi Unduh ---
    function downloadBytes(bytes, filename, mimeType = 'application/pdf') {
      const blob = new Blob([bytes], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

    // --- Logika Proses Utama (DIPERBARUI DENGAN LOGIKA FINALLY) ---
    processButton.addEventListener('click', async () => {
      const pagesToKeepStr = pagesToKeepInput.value;
      
      if (isProcessing) return;
      isProcessing = true;
      processButton.disabled = true;
      output.className = 'status-box status-processing';

      let filesProcessedCount = 0;
      let errorList = []; 
      const zip = new JSZip();
      let hasSucceeded = false; // Flag untuk melacak sukses

      try {
        const indicesToKeep = parsePageIndices(pagesToKeepStr);
        if (pdfFiles.length === 0) {
          throw new Error('Harap pilih file PDF terlebih dahulu!');
        }
        if (indicesToKeep.length === 0) {
          throw new Error('Harap masukkan nomor halaman yang valid! Contoh: 8 atau 1, 5-7');
        }
        
        output.textContent = `‚úÖ Validasi sukses. Memulai proses ${pdfFiles.length} file...`;

        for (let i = 0; i < pdfFiles.length; i++) {
          const file = pdfFiles[i];
          output.textContent = `üîß Memproses file ke-${i + 1} dari ${pdfFiles.length} (${file.name})...`;
          
          try {
            const buffer = await file.arrayBuffer(); 
            const existingPdf = await PDFDocument.load(buffer);
            const totalPages = existingPdf.getPageCount();

            const validIndicesToKeep = indicesToKeep.filter(index => index >= 0 && index < totalPages);
            
            if (validIndicesToKeep.length === 0) {
              throw new Error(`Halaman "${pagesToKeepStr}" tidak ada di file ini (total ${totalPages} hal).`);
            }
            
            const newPdf = await PDFDocument.create();
            const copiedPages = await newPdf.copyPages(existingPdf, validIndicesToKeep);
            copiedPages.forEach(page => newPdf.addPage(page));

            const pdfBytes = await newPdf.save();
            const originalName = file.name.replace(/\.pdf$/i, "");
            const finalName = `${originalName}${suffixInput.value}.pdf`;
            
            zip.file(finalName, pdfBytes);
            filesProcessedCount++;

          } catch (e) {
            console.error(`Gagal memproses file ${file.name}:`, e);
            errorList.push(`${file.name}: ${e.message}`);
          }
        }

        if (filesProcessedCount === 0) {
            const errorMsg = errorList.length > 0 ? errorList[0] : "Tidak ada file yang berhasil diproses.";
            throw new Error(errorMsg);
        }
        
        output.textContent = 'üì¶ Membuat file ZIP...';
        const zipBlob = await zip.generateAsync({ type: "blob" });
        const zipName = suffixInput.value ? `hasil_simpan${suffixInput.value}.zip` : "hasil_simpan_halaman.zip";
        downloadBytes(zipBlob, zipName, 'application/zip');
        
        output.className = 'status-box status-success';
        output.textContent = `üéâ Selesai! ${filesProcessedCount} file berhasil diproses.`;
        if (errorList.length > 0) {
            output.textContent += ` (${errorList.length} file gagal.)`;
            console.warn(`Error pertama: ${errorList[0]}`);
        }
        
        hasSucceeded = true; // Tandai bahwa proses berhasil

      } catch (e) {
        output.className = 'status-box status-error';
        output.textContent = `‚ùå Gagal! ${e.message}`;
        hasSucceeded = false; // Tandai bahwa proses gagal
      } finally {
        // --- BLOK FINALLY YANG DIPERBAIKI ---
        isProcessing = false;
        
        // Selalu aktifkan kembali tombol, terlepas dari sukses atau gagal
        processButton.disabled = false; 
        
        // HANYA reset UI jika proses SUKSES
        if (hasSucceeded) {
            // Tunggu 4 detik agar pesan sukses bisa dibaca
            await new Promise(res => setTimeout(res, 4000));
            resetUI();
        }
        // Jika gagal, biarkan pesan error tetap tampil.
        // Tombol sudah diaktifkan kembali.
      }
    });
    
    // Panggil resetUI saat halaman dimuat
    resetUI();

  </script>
</body>
</html>
